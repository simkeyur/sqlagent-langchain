<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Database Query</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .container {
            width: 100%;
            max-width: 90vw;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .settings-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-section {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-input {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            resize: vertical;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        .starter-prompts {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            margin-top: 12px;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }

        .starter-prompts::-webkit-scrollbar {
            height: 4px;
        }

        .starter-prompts::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        .starter-prompts::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .starter-prompts::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .starter-prompt {
            padding: 8px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .starter-prompt:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        }

        .search-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .search-btn:hover {
            background: #5568d3;
        }

        .search-btn:active {
            transform: scale(0.98);
        }

        .search-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .results-section {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .result-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 13px;
            line-height: 1.6;
        }

        .result-item pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .markdown-content {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .markdown-content h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 16px 0 12px 0;
            color: #111;
        }

        .markdown-content h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 14px 0 10px 0;
            color: #1f2937;
        }

        .markdown-content h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 12px 0 8px 0;
            color: #374151;
        }

        .markdown-content p {
            margin: 8px 0;
            color: #374151;
        }

        .markdown-content ul {
            margin: 8px 0;
            padding-left: 24px;
        }

        .markdown-content li {
            margin: 4px 0;
            color: #374151;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }

        .table-wrapper table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            table-layout: auto;
        }

        .table-wrapper thead tr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-wrapper th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            min-width: 100px;
        }

        .table-wrapper td {
            padding: 10px 12px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-wrapper tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .table-wrapper tbody tr:hover {
            background: #f0f4ff;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background: #f3f4f6;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-footer {
            background: #f9fafb;
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-secondary {
            padding: 10px 16px;
            background: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-primary {
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.ok {
            background: #10b981;
        }

        .status-indicator.error {
            background: #ef4444;
        }

        /* Responsive */
        @media (max-height: 600px) {
            .container {
                max-height: 95vh;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
            <h1>Employee Query</h1>
            <p>Search employee database with natural language</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <textarea
                    class="search-input"
                    id="queryInput"
                    placeholder="Ask me anything about employees...&#10;e.g., Show me Python developers in Engineering"
                    autocomplete="off"
                    onkeypress="handleKeyPress(event)"
                ></textarea>
                
                <!-- Starter Prompts -->
                <div class="starter-prompts">
                    <div class="starter-prompt" onclick="insertPrompt('Show me Python developers in Engineering')">üíª Python Devs</div>
                    <div class="starter-prompt" onclick="insertPrompt('Who are the senior employees?')">üëî Senior Staff</div>
                    <div class="starter-prompt" onclick="insertPrompt('Count employees by department')">üìä By Department</div>
                    <div class="starter-prompt" onclick="insertPrompt('Find employees hired in last 2 years')">üìÖ New Hires</div>
                </div>

                <button class="search-btn" id="searchBtn" onclick="executeQuery()">Search</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <p>Enter a query to search the employee database</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Google Gemini API Key</label>
                    <input
                        type="password"
                        id="apiKeyInput"
                        placeholder="Enter your Google API key"
                    >
                    <small style="color: #6b7280; margin-top: 6px; display: block;">
                        Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #667eea;">Google AI Studio</a>
                    </small>
                </div>
                <div id="apiKeyStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '/api';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkApiKeyStatus();
        });

        // Check API Key Status
        async function checkApiKeyStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                updateApiKeyStatus(data.api_key_configured);
            } catch (error) {
                console.error('Error checking API key status:', error);
            }
        }

        // Update API Key Status Display
        function updateApiKeyStatus(configured) {
            const statusEl = document.getElementById('apiKeyStatus');
            if (configured) {
                statusEl.innerHTML = '<div class="success-message"><span class="status-indicator ok"></span>API Key configured</div>';
            } else {
                statusEl.innerHTML = '<div class="error-message"><span class="status-indicator error"></span>API Key not configured</div>';
            }
        }

        // Open Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // Close Settings Modal
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Save Settings
        async function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey })
                });

                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiKeyInput').value = '';
                    updateApiKeyStatus(true);
                    setTimeout(() => closeSettings(), 1000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to save settings'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }

        // Insert starter prompt into textarea
        function insertPrompt(prompt) {
            const queryInput = document.getElementById('queryInput');
            queryInput.value = prompt;
            queryInput.focus();
        }

        // Handle Enter Key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                executeQuery();
            }
        }

        // Execute Query
        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('Please enter a query');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('resultsContainer');

            // Disable button and show loading
            searchBtn.disabled = true;
            searchBtn.classList.add('loading');
            searchBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayResult(data.result, resultsContainer);
                } else {
                    displayError(data.error || 'Query failed', resultsContainer);
                }
            } catch (error) {
                displayError('Error: ' + error.message, resultsContainer);
            } finally {
                // Re-enable button
                searchBtn.disabled = false;
                searchBtn.classList.remove('loading');
                searchBtn.innerHTML = 'Search';
            }
        }

        // Display Result
        function displayResult(result, container) {
            container.innerHTML = '';
            
            console.log('Processing result:', result.substring(0, 100));
            
            // Check if result contains markdown table
            if (result.includes('|')) {
                const table = parseMarkdownTable(result);
                if (table && table.rows && table.rows.length > 0) {
                    console.log('‚úÖ Markdown table detected and parsed');
                    displayMarkdownTable(table, container);
                    return;
                }
            }
            
            console.log('üìÑ Displaying as markdown (no table detected)');
            // Try to parse and display markdown
            const markdown = parseMarkdown(result);
            displayMarkdown(markdown, container);
        }
        
        // Simple markdown parser
        function parseMarkdown(markdown) {
            const lines = markdown.split('\n');
            const elements = [];
            let currentList = [];
            
            for (let line of lines) {
                const trimmed = line.trim();
                
                // Skip empty lines
                if (!trimmed) {
                    if (currentList.length > 0) {
                        elements.push({ type: 'list', items: currentList });
                        currentList = [];
                    }
                    continue;
                }
                
                // Bold and italic
                if (trimmed.startsWith('###')) {
                    if (currentList.length > 0) {
                        elements.push({ type: 'list', items: currentList });
                        currentList = [];
                    }
                    elements.push({ type: 'h3', text: trimmed.replace(/^#+\s*/, '').trim() });
                } else if (trimmed.startsWith('##')) {
                    if (currentList.length > 0) {
                        elements.push({ type: 'list', items: currentList });
                        currentList = [];
                    }
                    elements.push({ type: 'h2', text: trimmed.replace(/^#+\s*/, '').trim() });
                } else if (trimmed.startsWith('#')) {
                    if (currentList.length > 0) {
                        elements.push({ type: 'list', items: currentList });
                        currentList = [];
                    }
                    elements.push({ type: 'h1', text: trimmed.replace(/^#+\s*/, '').trim() });
                } else if (trimmed.startsWith('-') || trimmed.startsWith('*')) {
                    currentList.push(trimmed.replace(/^[-*]\s*/, '').trim());
                } else {
                    if (currentList.length > 0) {
                        elements.push({ type: 'list', items: currentList });
                        currentList = [];
                    }
                    elements.push({ type: 'paragraph', text: trimmed });
                }
            }
            
            if (currentList.length > 0) {
                elements.push({ type: 'list', items: currentList });
            }
            
            return elements;
        }
        
        // Display parsed markdown
        function displayMarkdown(elements, container) {
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'font-size: 14px; line-height: 1.6; color: #374151;';
            
            elements.forEach(el => {
                if (el.type === 'h1') {
                    const h1 = document.createElement('h1');
                    h1.textContent = el.text;
                    h1.style.cssText = 'font-size: 20px; font-weight: 700; margin: 16px 0 12px 0;';
                    wrapper.appendChild(h1);
                } else if (el.type === 'h2') {
                    const h2 = document.createElement('h2');
                    h2.textContent = el.text;
                    h2.style.cssText = 'font-size: 18px; font-weight: 600; margin: 14px 0 10px 0;';
                    wrapper.appendChild(h2);
                } else if (el.type === 'h3') {
                    const h3 = document.createElement('h3');
                    h3.textContent = el.text;
                    h3.style.cssText = 'font-size: 16px; font-weight: 600; margin: 12px 0 8px 0;';
                    wrapper.appendChild(h3);
                } else if (el.type === 'paragraph') {
                    const p = document.createElement('p');
                    p.textContent = el.text;
                    p.style.cssText = 'margin: 8px 0;';
                    wrapper.appendChild(p);
                } else if (el.type === 'list') {
                    const ul = document.createElement('ul');
                    ul.style.cssText = 'margin: 8px 0; padding-left: 24px;';
                    el.items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        li.style.cssText = 'margin: 4px 0;';
                        ul.appendChild(li);
                    });
                    wrapper.appendChild(ul);
                }
            });
            
            container.appendChild(wrapper);
        }
        
        // Parse markdown table to HTML
        function parseMarkdownTable(markdown) {
            const lines = markdown.split('\n');
            
            let tableStart = -1;
            let separatorStart = -1;
            
            // Find table start (first line with pipes)
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('|')) {
                    tableStart = i;
                    break;
                }
            }
            
            if (tableStart === -1) {
                console.log('‚ùå No table start found');
                return null;
            }
            
            // Parse headers
            const headerLine = lines[tableStart];
            const headers = headerLine
                .split('|')
                .map(h => h.trim())
                .filter(h => h.length > 0);
            
            if (headers.length === 0) {
                console.log('‚ùå No headers found');
                return null;
            }
            
            console.log('‚úÖ Headers found:', headers.length, headers);
            
            // Find and skip separator line (usually has dashes)
            let rowStart = tableStart + 1;
            for (let i = tableStart + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.includes('---') || (line.includes('|') && line.replace(/[|\s-]/g, '').length === 0)) {
                    separatorStart = i;
                    rowStart = i + 1;
                    break;
                }
                if (line.includes('|')) {
                    // No separator found, data rows start here
                    rowStart = i;
                    break;
                }
            }
            
            console.log('üìç Row start index:', rowStart, 'Separator at:', separatorStart);
            
            // Parse data rows
            const rows = [];
            for (let i = rowStart; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line.includes('|') || line.length === 0) continue;
                
                const cells = line
                    .split('|')
                    .map(c => c.trim())
                    .filter(c => c.length > 0);
                
                // Allow some flexibility in column count
                if (cells.length > 0 && cells.length >= headers.length - 1) {
                    // Pad or trim cells to match header count
                    while (cells.length < headers.length) {
                        cells.push('');
                    }
                    rows.push(cells.slice(0, headers.length));
                }
            }
            
            console.log('‚úÖ Parsed rows:', rows.length, 'rows');
            
            if (rows.length === 0) {
                console.log('‚ùå No data rows found');
                return null;
            }
            
            return { headers, rows };
        }
        
        // Display parsed markdown table
        function displayMarkdownTable(table, container) {
            const { headers, rows } = table;
            
            if (rows.length === 0) {
                container.innerHTML = '<div class="result-item">No results found</div>';
                return;
            }
            
            // Create result header
            const resultHeader = document.createElement('div');
            resultHeader.style.cssText = 'padding: 12px 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 12px; font-weight: 600; color: #667eea; font-size: 13px;';
            resultHeader.textContent = `Found ${rows.length} result${rows.length !== 1 ? 's' : ''}`;
            container.appendChild(resultHeader);
            
            // Create table wrapper with scroll
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-wrapper';
            
            // Create table
            const table_html = document.createElement('table');
            
            // Table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table_html.appendChild(thead);
            
            // Table body
            const tbody = document.createElement('tbody');
            rows.forEach((row) => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table_html.appendChild(tbody);
            
            tableWrapper.appendChild(table_html);
            container.appendChild(tableWrapper);
        }

        // Display Error
        function displayError(error, container) {
            container.innerHTML = '';
            const item = document.createElement('div');
            item.className = 'error-message';
            item.textContent = error;
            container.appendChild(item);
        }

        // Escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Close modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeSettings();
            }
        });
    </script>
</body>
</html>
